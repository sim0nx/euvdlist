{
  "id": "EUVD-2024-51838",
  "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nblock, bfq: fix bfqq uaf in bfq_limit_depth()\n\nSet new allocated bfqq to bic or remove freed bfqq from bic are both\nprotected by bfqd->lock, however bfq_limit_depth() is deferencing bfqq\nfrom bic without the lock, this can lead to UAF if the io_context is\nshared by multiple tasks.\n\nFor example, test bfq with io_uring can trigger following UAF in v6.6:\n\n==================================================================\nBUG: KASAN: slab-use-after-free in bfqq_group+0x15/0x50\n\nCall Trace:\n <TASK>\n dump_stack_lvl+0x47/0x80\n print_address_description.constprop.0+0x66/0x300\n print_report+0x3e/0x70\n kasan_report+0xb4/0xf0\n bfqq_group+0x15/0x50\n bfqq_request_over_limit+0x130/0x9a0\n bfq_limit_depth+0x1b5/0x480\n __blk_mq_alloc_requests+0x2b5/0xa00\n blk_mq_get_new_requests+0x11d/0x1d0\n blk_mq_submit_bio+0x286/0xb00\n submit_bio_noacct_nocheck+0x331/0x400\n __block_write_full_folio+0x3d0/0x640\n writepage_cb+0x3b/0xc0\n write_cache_pages+0x254/0x6c0\n write_cache_pages+0x254/0x6c0\n do_writepages+0x192/0x310\n filemap_fdatawrite_wbc+0x95/0xc0\n __filemap_fdatawrite_range+0x99/0xd0\n filemap_write_and_wait_range.part.0+0x4d/0xa0\n blkdev_read_iter+0xef/0x1e0\n io_read+0x1b6/0x8a0\n io_issue_sqe+0x87/0x300\n io_wq_submit_work+0xeb/0x390\n io_worker_handle_work+0x24d/0x550\n io_wq_worker+0x27f/0x6c0\n ret_from_fork_asm+0x1b/0x30\n </TASK>\n\nAllocated by task 808602:\n kasan_save_stack+0x1e/0x40\n kasan_set_track+0x21/0x30\n __kasan_slab_alloc+0x83/0x90\n kmem_cache_alloc_node+0x1b1/0x6d0\n bfq_get_queue+0x138/0xfa0\n bfq_get_bfqq_handle_split+0xe3/0x2c0\n bfq_init_rq+0x196/0xbb0\n bfq_insert_request.isra.0+0xb5/0x480\n bfq_insert_requests+0x156/0x180\n blk_mq_insert_request+0x15d/0x440\n blk_mq_submit_bio+0x8a4/0xb00\n submit_bio_noacct_nocheck+0x331/0x400\n __blkdev_direct_IO_async+0x2dd/0x330\n blkdev_write_iter+0x39a/0x450\n io_write+0x22a/0x840\n io_issue_sqe+0x87/0x300\n io_wq_submit_work+0xeb/0x390\n io_worker_handle_work+0x24d/0x550\n io_wq_worker+0x27f/0x6c0\n ret_from_fork+0x2d/0x50\n ret_from_fork_asm+0x1b/0x30\n\nFreed by task 808589:\n kasan_save_stack+0x1e/0x40\n kasan_set_track+0x21/0x30\n kasan_save_free_info+0x27/0x40\n __kasan_slab_free+0x126/0x1b0\n kmem_cache_free+0x10c/0x750\n bfq_put_queue+0x2dd/0x770\n __bfq_insert_request.isra.0+0x155/0x7a0\n bfq_insert_request.isra.0+0x122/0x480\n bfq_insert_requests+0x156/0x180\n blk_mq_dispatch_plug_list+0x528/0x7e0\n blk_mq_flush_plug_list.part.0+0xe5/0x590\n __blk_flush_plug+0x3b/0x90\n blk_finish_plug+0x40/0x60\n do_writepages+0x19d/0x310\n filemap_fdatawrite_wbc+0x95/0xc0\n __filemap_fdatawrite_range+0x99/0xd0\n filemap_write_and_wait_range.part.0+0x4d/0xa0\n blkdev_read_iter+0xef/0x1e0\n io_read+0x1b6/0x8a0\n io_issue_sqe+0x87/0x300\n io_wq_submit_work+0xeb/0x390\n io_worker_handle_work+0x24d/0x550\n io_wq_worker+0x27f/0x6c0\n ret_from_fork+0x2d/0x50\n ret_from_fork_asm+0x1b/0x30\n\nFix the problem by protecting bic_to_bfqq() with bfqd->lock.",
  "datePublished": "Dec 27, 2024, 1:49:12 PM",
  "dateUpdated": "Feb 10, 2025, 5:21:09 PM",
  "baseScore": 7.8,
  "baseScoreVersion": "3.1",
  "baseScoreVector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
  "references": [
    "https://git.kernel.org/stable/c/906cdbdd3b018ff69cc830173bce277a847d4fdc",
    "https://git.kernel.org/stable/c/dcaa738afde55085ac6056252e319479cf23cde2",
    "https://git.kernel.org/stable/c/01a853faaeaf3379ccf358ade582b1d28752126e",
    "https://git.kernel.org/stable/c/e8b8344de3980709080d86c157d24e7de07d70ad"
  ],
  "aliases": [
    "CVE-2024-53166"
  ],
  "assigner": "Linux",
  "epss": 0.03,
  "enisaIdProduct": [
    {
      "id": "01e359ad-f342-39a7-91b5-89ca34e2e291",
      "product": {
        "name": "Linux"
      },
      "product_version": "76f1df88bbc2f984eb0418cc90de0a8384e63604 <dcaa738afde55085ac6056252e319479cf23cde2"
    },
    {
      "id": "085b8a00-bd36-38c0-ab48-385bbf081f7f",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.1.130"
    },
    {
      "id": "37298562-2bac-3225-b260-443a04bfed3f",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.13"
    },
    {
      "id": "49ed6012-4797-34ca-8cd9-c458099ecb20",
      "product": {
        "name": "Linux"
      },
      "product_version": "76f1df88bbc2f984eb0418cc90de0a8384e63604 <01a853faaeaf3379ccf358ade582b1d28752126e"
    },
    {
      "id": "6c661bd2-8dc3-3e75-b057-7ecbba4195bd",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.6.64"
    },
    {
      "id": "6d089145-ddcb-301d-b01c-9064f7c870f9",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.11.11"
    },
    {
      "id": "a1fe5fb5-3e1d-3cea-9120-c3b2b874ebdc",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.12.2"
    },
    {
      "id": "ad138f7b-e475-3f47-bc54-39bb3ceaca4d",
      "product": {
        "name": "Linux"
      },
      "product_version": "5.17"
    },
    {
      "id": "b5564871-88e4-3945-8b51-7b8d40f658ed",
      "product": {
        "name": "Linux"
      },
      "product_version": "76f1df88bbc2f984eb0418cc90de0a8384e63604 <e8b8344de3980709080d86c157d24e7de07d70ad"
    },
    {
      "id": "dc5fe8c1-16b1-3ade-9db9-487f214b731d",
      "product": {
        "name": "Linux"
      },
      "product_version": "76f1df88bbc2f984eb0418cc90de0a8384e63604 <906cdbdd3b018ff69cc830173bce277a847d4fdc"
    },
    {
      "id": "f10f8fcd-baaa-3490-8a09-91f2e66af3df",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 0"
    }
  ],
  "enisaIdVendor": [
    {
      "id": "2b66a002-d08b-3a3a-84f3-8e78e0e028d7",
      "vendor": {
        "name": "Linux"
      }
    }
  ],
  "cve": "CVE-2024-53166"
}
