{
  "id": "EUVD-2025-13126",
  "description": "In the Linux kernel, the following vulnerability has been resolved:\n\next4: fix another off-by-one fsmap error on 1k block filesystems\n\nApparently syzbot figured out that issuing this FSMAP call:\n\nstruct fsmap_head cmd = {\n\t.fmh_count\t= ...;\n\t.fmh_keys\t= {\n\t\t{ .fmr_device = /* ext4 dev */, .fmr_physical = 0, },\n\t\t{ .fmr_device = /* ext4 dev */, .fmr_physical = 0, },\n\t},\n...\n};\nret = ioctl(fd, FS_IOC_GETFSMAP, &cmd);\n\nProduces this crash if the underlying filesystem is a 1k-block ext4\nfilesystem:\n\nkernel BUG at fs/ext4/ext4.h:3331!\ninvalid opcode: 0000 [#1] PREEMPT SMP\nCPU: 3 PID: 3227965 Comm: xfs_io Tainted: G        W  O       6.2.0-rc8-achx\nHardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.15.0-1 04/01/2014\nRIP: 0010:ext4_mb_load_buddy_gfp+0x47c/0x570 [ext4]\nRSP: 0018:ffffc90007c03998 EFLAGS: 00010246\nRAX: ffff888004978000 RBX: ffffc90007c03a20 RCX: ffff888041618000\nRDX: 0000000000000000 RSI: 00000000000005a4 RDI: ffffffffa0c99b11\nRBP: ffff888012330000 R08: ffffffffa0c2b7d0 R09: 0000000000000400\nR10: ffffc90007c03950 R11: 0000000000000000 R12: 0000000000000001\nR13: 00000000ffffffff R14: 0000000000000c40 R15: ffff88802678c398\nFS:  00007fdf2020c880(0000) GS:ffff88807e100000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 00007ffd318a5fe8 CR3: 000000007f80f001 CR4: 00000000001706e0\nCall Trace:\n <TASK>\n ext4_mballoc_query_range+0x4b/0x210 [ext4 dfa189daddffe8fecd3cdfd00564e0f265a8ab80]\n ext4_getfsmap_datadev+0x713/0x890 [ext4 dfa189daddffe8fecd3cdfd00564e0f265a8ab80]\n ext4_getfsmap+0x2b7/0x330 [ext4 dfa189daddffe8fecd3cdfd00564e0f265a8ab80]\n ext4_ioc_getfsmap+0x153/0x2b0 [ext4 dfa189daddffe8fecd3cdfd00564e0f265a8ab80]\n __ext4_ioctl+0x2a7/0x17e0 [ext4 dfa189daddffe8fecd3cdfd00564e0f265a8ab80]\n __x64_sys_ioctl+0x82/0xa0\n do_syscall_64+0x2b/0x80\n entry_SYSCALL_64_after_hwframe+0x46/0xb0\nRIP: 0033:0x7fdf20558aff\nRSP: 002b:00007ffd318a9e30 EFLAGS: 00000246 ORIG_RAX: 0000000000000010\nRAX: ffffffffffffffda RBX: 00000000000200c0 RCX: 00007fdf20558aff\nRDX: 00007fdf1feb2010 RSI: 00000000c0c0583b RDI: 0000000000000003\nRBP: 00005625c0634be0 R08: 00005625c0634c40 R09: 0000000000000001\nR10: 0000000000000000 R11: 0000000000000246 R12: 00007fdf1feb2010\nR13: 00005625be70d994 R14: 0000000000000800 R15: 0000000000000000\n\nFor GETFSMAP calls, the caller selects a physical block device by\nwriting its block number into fsmap_head.fmh_keys[01].fmr_device.\nTo query mappings for a subrange of the device, the starting byte of the\nrange is written to fsmap_head.fmh_keys[0].fmr_physical and the last\nbyte of the range goes in fsmap_head.fmh_keys[1].fmr_physical.\n\nIOWs, to query what mappings overlap with bytes 3-14 of /dev/sda, you'd\nset the inputs as follows:\n\n\tfmh_keys[0] = { .fmr_device = major(8, 0), .fmr_physical = 3},\n\tfmh_keys[1] = { .fmr_device = major(8, 0), .fmr_physical = 14},\n\nWhich would return you whatever is mapped in the 12 bytes starting at\nphysical offset 3.\n\nThe crash is due to insufficient range validation of keys[1] in\next4_getfsmap_datadev.  On 1k-block filesystems, block 0 is not part of\nthe filesystem, which means that s_first_data_block is nonzero.\next4_get_group_no_and_offset subtracts this quantity from the blocknr\nargument before cracking it into a group number and a block number\nwithin a group.  IOWs, block group 0 spans blocks 1-8192 (1-based)\ninstead of 0-8191 (0-based) like what happens with larger blocksizes.\n\nThe net result of this encoding is that blocknr < s_first_data_block is\nnot a valid input to this function.  The end_fsb variable is set from\nthe keys that are copied from userspace, which means that in the above\nexample, its value is zero.  That leads to an underflow here:\n\n\tblocknr = blocknr - le32_to_cpu(es->s_first_data_block);\n\nThe division then operates on -1:\n\n\toffset = do_div(blocknr, EXT4_BLOCKS_PER_GROUP(sb)) >>\n\t\tEXT4_SB(sb)->s_cluster_bits;\n\nLeaving an impossibly large group number (2^32-1) in blocknr.\next4_getfsmap_check_keys checked that keys[0\n---truncated---",
  "datePublished": "May 2, 2025, 3:56:13 PM",
  "dateUpdated": "May 2, 2025, 3:56:13 PM",
  "baseScore": 0.0,
  "references": [
    "https://nvd.nist.gov/vuln/detail/CVE-2023-53143",
    "https://git.kernel.org/stable/c/15ebade3266b300da9cd1edce4004fe8fd6a2b88",
    "https://git.kernel.org/stable/c/1d2366624b4c19a2ba6baf67fe57f4a1b0f67c05",
    "https://git.kernel.org/stable/c/a70b49dc7eee5dbe3775a650ce598e3557ff5475",
    "https://git.kernel.org/stable/c/c24f838493792b5e78a3596b4ca96375aa0af4c2",
    "https://git.kernel.org/stable/c/c5d7c31e17224d847a330180ec1b03bf390632b2",
    "https://git.kernel.org/stable/c/c993799baf9c5861f8df91beb80e1611b12efcbd",
    "https://git.kernel.org/stable/c/eb3a695aa71a514f2e7f5778e05faba3733b70a0",
    "https://git.kernel.org/stable/c/f16054ac1774915160ca4e1c73ff7a269465a1b9"
  ],
  "aliases": [
    "CVE-2023-53143",
    "GHSA-5vjg-59f8-hcq8"
  ],
  "assigner": "Linux",
  "epss": 0.04,
  "enisaIdProduct": [
    {
      "id": "0a4d9a91-8b37-374f-bda7-1603eac1ce66",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <a70b49dc7eee5dbe3775a650ce598e3557ff5475"
    },
    {
      "id": "150e67ea-5771-383c-a3a6-1ff56815ae71",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <c5d7c31e17224d847a330180ec1b03bf390632b2"
    },
    {
      "id": "315ef2fa-5795-39b6-afc8-272bbce254d9",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 4.14.310"
    },
    {
      "id": "3c322d12-5dc8-3736-a75f-61ac816fd0e5",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 4.19.278"
    },
    {
      "id": "46be8f36-fc47-35f7-80a2-96ce1e766529",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 0"
    },
    {
      "id": "534114ee-478f-31e5-86d1-9255253e14f9",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <c993799baf9c5861f8df91beb80e1611b12efcbd"
    },
    {
      "id": "5bbe9e9e-76e1-3d6e-8742-c4c46317363d",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.15.103"
    },
    {
      "id": "65070342-c616-3a14-a0e0-421666264c96",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <eb3a695aa71a514f2e7f5778e05faba3733b70a0"
    },
    {
      "id": "79ac29b6-e46d-3a65-af95-38e96b285a98",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.2.7"
    },
    {
      "id": "81fb617c-8573-31d1-8484-6c66fde915e1",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <15ebade3266b300da9cd1edce4004fe8fd6a2b88"
    },
    {
      "id": "82888351-ef6f-3969-8cba-1942a5a4af25",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.3"
    },
    {
      "id": "8851ebbf-04a9-39ab-a5e1-d91ec26cc1b4",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 6.1.20"
    },
    {
      "id": "baddc048-4465-35c7-9eb5-323779b2dd57",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.4.237"
    },
    {
      "id": "be491519-4877-3b92-b8f9-9b49f2765b72",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <1d2366624b4c19a2ba6baf67fe57f4a1b0f67c05"
    },
    {
      "id": "c9e8e2ed-c815-3e2a-a9c0-c5a942441626",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <c24f838493792b5e78a3596b4ca96375aa0af4c2"
    },
    {
      "id": "cbcc22aa-023b-30ac-9c51-d922a3c7d3bc",
      "product": {
        "name": "Linux"
      },
      "product_version": "4a4956249dac0b9b0027949907bff0cd1a9b57fa <f16054ac1774915160ca4e1c73ff7a269465a1b9"
    },
    {
      "id": "f974c062-5e29-37d5-a330-8285c5b6542c",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.10.175"
    },
    {
      "id": "fcd88530-603a-312a-9246-ed47f3dbc7f4",
      "product": {
        "name": "Linux"
      },
      "product_version": "4.13"
    }
  ],
  "enisaIdVendor": [
    {
      "id": "c4edeca5-b069-3651-8982-0776b370284a",
      "vendor": {
        "name": "Linux"
      }
    }
  ],
  "cve": "CVE-2023-53143"
}
