{
  "id": "EUVD-2022-55145",
  "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nnfc: nci: add flush_workqueue to prevent uaf\n\nOur detector found a concurrent use-after-free bug when detaching an\nNCI device. The main reason for this bug is the unexpected scheduling\nbetween the used delayed mechanism (timer and workqueue).\n\nThe race can be demonstrated below:\n\nThread-1                           Thread-2\n                                 | nci_dev_up()\n                                 |   nci_open_device()\n                                 |     __nci_request(nci_reset_req)\n                                 |       nci_send_cmd\n                                 |         queue_work(cmd_work)\nnci_unregister_device()          |\n  nci_close_device()             | ...\n    del_timer_sync(cmd_timer)[1] |\n...                              | Worker\nnci_free_device()                | nci_cmd_work()\n  kfree(ndev)[3]                 |   mod_timer(cmd_timer)[2]\n\nIn short, the cleanup routine thought that the cmd_timer has already\nbeen detached by [1] but the mod_timer can re-attach the timer [2], even\nit is already released [3], resulting in UAF.\n\nThis UAF is easy to trigger, crash trace by POC is like below\n\n[   66.703713] ==================================================================\n[   66.703974] BUG: KASAN: use-after-free in enqueue_timer+0x448/0x490\n[   66.703974] Write of size 8 at addr ffff888009fb7058 by task kworker/u4:1/33\n[   66.703974]\n[   66.703974] CPU: 1 PID: 33 Comm: kworker/u4:1 Not tainted 5.18.0-rc2 #5\n[   66.703974] Workqueue: nfc2_nci_cmd_wq nci_cmd_work\n[   66.703974] Call Trace:\n[   66.703974]  <TASK>\n[   66.703974]  dump_stack_lvl+0x57/0x7d\n[   66.703974]  print_report.cold+0x5e/0x5db\n[   66.703974]  ? enqueue_timer+0x448/0x490\n[   66.703974]  kasan_report+0xbe/0x1c0\n[   66.703974]  ? enqueue_timer+0x448/0x490\n[   66.703974]  enqueue_timer+0x448/0x490\n[   66.703974]  __mod_timer+0x5e6/0xb80\n[   66.703974]  ? mark_held_locks+0x9e/0xe0\n[   66.703974]  ? try_to_del_timer_sync+0xf0/0xf0\n[   66.703974]  ? lockdep_hardirqs_on_prepare+0x17b/0x410\n[   66.703974]  ? queue_work_on+0x61/0x80\n[   66.703974]  ? lockdep_hardirqs_on+0xbf/0x130\n[   66.703974]  process_one_work+0x8bb/0x1510\n[   66.703974]  ? lockdep_hardirqs_on_prepare+0x410/0x410\n[   66.703974]  ? pwq_dec_nr_in_flight+0x230/0x230\n[   66.703974]  ? rwlock_bug.part.0+0x90/0x90\n[   66.703974]  ? _raw_spin_lock_irq+0x41/0x50\n[   66.703974]  worker_thread+0x575/0x1190\n[   66.703974]  ? process_one_work+0x1510/0x1510\n[   66.703974]  kthread+0x2a0/0x340\n[   66.703974]  ? kthread_complete_and_exit+0x20/0x20\n[   66.703974]  ret_from_fork+0x22/0x30\n[   66.703974]  </TASK>\n[   66.703974]\n[   66.703974] Allocated by task 267:\n[   66.703974]  kasan_save_stack+0x1e/0x40\n[   66.703974]  __kasan_kmalloc+0x81/0xa0\n[   66.703974]  nci_allocate_device+0xd3/0x390\n[   66.703974]  nfcmrvl_nci_register_dev+0x183/0x2c0\n[   66.703974]  nfcmrvl_nci_uart_open+0xf2/0x1dd\n[   66.703974]  nci_uart_tty_ioctl+0x2c3/0x4a0\n[   66.703974]  tty_ioctl+0x764/0x1310\n[   66.703974]  __x64_sys_ioctl+0x122/0x190\n[   66.703974]  do_syscall_64+0x3b/0x90\n[   66.703974]  entry_SYSCALL_64_after_hwframe+0x44/0xae\n[   66.703974]\n[   66.703974] Freed by task 406:\n[   66.703974]  kasan_save_stack+0x1e/0x40\n[   66.703974]  kasan_set_track+0x21/0x30\n[   66.703974]  kasan_set_free_info+0x20/0x30\n[   66.703974]  __kasan_slab_free+0x108/0x170\n[   66.703974]  kfree+0xb0/0x330\n[   66.703974]  nfcmrvl_nci_unregister_dev+0x90/0xd0\n[   66.703974]  nci_uart_tty_close+0xdf/0x180\n[   66.703974]  tty_ldisc_kill+0x73/0x110\n[   66.703974]  tty_ldisc_hangup+0x281/0x5b0\n[   66.703974]  __tty_hangup.part.0+0x431/0x890\n[   66.703974]  tty_release+0x3a8/0xc80\n[   66.703974]  __fput+0x1f0/0x8c0\n[   66.703974]  task_work_run+0xc9/0x170\n[   66.703974]  exit_to_user_mode_prepare+0x194/0x1a0\n[   66.703974]  syscall_exit_to_user_mode+0x19/0x50\n[   66.703974]  do_syscall_64+0x48/0x90\n[   66.703974]  entry_SYSCALL_64_after_hwframe+0x44/0x\n---truncated---",
  "datePublished": "Feb 26, 2025, 1:54:29 AM",
  "dateUpdated": "Feb 26, 2025, 1:54:29 AM",
  "baseScore": 0.0,
  "references": [
    "https://git.kernel.org/stable/c/7d3232214ca4ea8f7d18df264c3b254aa8089d7f",
    "https://git.kernel.org/stable/c/9d243aff5f7e6b04e907c617426bbdf26e996ac8",
    "https://git.kernel.org/stable/c/1a1748d0dd0f0a98535c6baeef671c8722107639",
    "https://git.kernel.org/stable/c/5c63ad2b0a267a524c12c88acb1ba9c2d109a801",
    "https://git.kernel.org/stable/c/67677050cecbe0edfdd81cd508415e9636ba7c65",
    "https://git.kernel.org/stable/c/9ded5ae40f4fe37fcc28f36d76bf45df20be5432",
    "https://git.kernel.org/stable/c/edd4600120641e1714e30112e69a548cfb68e067",
    "https://git.kernel.org/stable/c/ef27324e2cb7bb24542d6cb2571740eefe6b00dc"
  ],
  "aliases": [
    "CVE-2022-49059"
  ],
  "assigner": "Linux",
  "epss": 0.02,
  "enisaIdProduct": [
    {
      "id": "019a2dea-d29e-30a9-8cfb-8eea1f8fc1bb",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.15.35"
    },
    {
      "id": "04a37575-fcdc-3cc1-87e8-b29fcc74067d",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <67677050cecbe0edfdd81cd508415e9636ba7c65"
    },
    {
      "id": "05057491-beb8-3c1b-afb4-6558e7659100",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <ef27324e2cb7bb24542d6cb2571740eefe6b00dc"
    },
    {
      "id": "062fb7e1-9bd9-3412-90fe-6c4362155425",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <5c63ad2b0a267a524c12c88acb1ba9c2d109a801"
    },
    {
      "id": "3914a9fb-3cd8-3d05-8916-69c5b9103c4f",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 4.9.311"
    },
    {
      "id": "70869786-d0c7-307d-b876-a1334599068a",
      "product": {
        "name": "Linux"
      },
      "product_version": "3.2"
    },
    {
      "id": "799bef20-6d82-39f7-b170-3089ff88a45e",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <7d3232214ca4ea8f7d18df264c3b254aa8089d7f"
    },
    {
      "id": "8eb07eaf-1c71-3315-a3a4-fc58c4925051",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <1a1748d0dd0f0a98535c6baeef671c8722107639"
    },
    {
      "id": "915a9327-77ec-3182-b651-7851d8072f3b",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <9ded5ae40f4fe37fcc28f36d76bf45df20be5432"
    },
    {
      "id": "a889f22e-467e-3d9b-83c4-df459a945ae0",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 4.19.239"
    },
    {
      "id": "ae553c2e-bea8-3398-886a-9bfd3882cdb1",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <edd4600120641e1714e30112e69a548cfb68e067"
    },
    {
      "id": "aeb9ddd3-bb65-346f-ba10-ca92e1b7c7a0",
      "product": {
        "name": "Linux"
      },
      "product_version": "6a2968aaf50c7a22fced77a5e24aa636281efca8 <9d243aff5f7e6b04e907c617426bbdf26e996ac8"
    },
    {
      "id": "c43895e3-0235-3c47-8bac-3a3f0b76f4ae",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.18"
    },
    {
      "id": "c5f39b77-7dcc-3459-b24c-67b339e20fb8",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.10.112"
    },
    {
      "id": "d654cb8f-d5fe-32ad-b8da-f43716cdf026",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.17.4"
    },
    {
      "id": "e08cbc9a-c125-32c2-be5e-63bf16da8327",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 0"
    },
    {
      "id": "f0fbc7c8-ca41-3c53-8360-5275363a01aa",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 4.14.276"
    },
    {
      "id": "f7a0ff51-2d90-38fe-ab28-1f1f539c3a90",
      "product": {
        "name": "Linux"
      },
      "product_version": "patch: 5.4.190"
    }
  ],
  "enisaIdVendor": [
    {
      "id": "364be00f-568c-3f45-a596-1ddc47174a4a",
      "vendor": {
        "name": "Linux"
      }
    }
  ],
  "cve": "CVE-2022-49059"
}
